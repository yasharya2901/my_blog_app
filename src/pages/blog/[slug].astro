---
import App from "../../layout/app.astro";
import { blogApi } from "../../lib/api/blog";
import { marked } from "marked";
import RouteError from "../../components/ErrorPages/RouteError";
import { getTagColor } from "../../lib/utils/tag-colors";
import { FaCalendarDays, FaUser, FaXTwitter, FaInstagram, FaWhatsapp, FaSignalMessenger } from "react-icons/fa6";

const { slug } = Astro.params;
if (!slug) {
    return Astro.redirect("/");
}

let blog;
let blogHtml = "";
try {
    blog = await blogApi.getABlogUsingSlug(slug);
    blogHtml = await marked.parse(blog.content);
} catch (error) {
    console.error("Blog not found:", error);
    // Return 404 status for non-existent blogs
    return new Response(null, {
        status: 404,
        statusText: 'Not Found'
    });
}

// Helper to extract border color from getTagColor result
const getBorderColor = (tagColorClass: string) => {
    const match = tagColorClass.match(/bg-\[(#[A-Fa-f0-9]+)\]/);
    return match ? match[1] : '#4ADE80';
};
---

<App title={blog?.title}>
    {!blog ? 
        <RouteError client:load /> : 
        <div class="max-w-4xl mx-auto px-4 py-12">
            <!-- Header -->
            <header class="mb-8">
                <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6 text-white">{blog.title}</h1>
                
                <!-- Meta Info -->
                <div class="flex flex-wrap items-center text-gray-400 mb-6 gap-4">
                    <div class="flex items-center">
                        <FaCalendarDays className="h-5 w-5 mr-2 text-[#4ADE80]" />
                        <time datetime={blog.datePublished ?? ""}>
                            {new Date(blog.datePublished ?? "").toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </time>
                    </div>
                    <div class="flex items-center">
                        <FaUser className="h-5 w-5 mr-2 text-[#C084FC]" />
                        <span>Written by <a href="https://www.yasharya.me" target="_blank" class="text-[#4ADE80] hover:underline cursor-pointer">{blog.author.name}</a></span>
                    </div>
                </div>

                <!-- Tags -->
                <div class="flex flex-wrap gap-2 mb-8">
                    {blog.tags.map((tag) => {
                        const colorClass = getTagColor(tag.name);
                        const borderColor = getBorderColor(colorClass);
                        return (
                            <button 
                                class="tag-btn bg-[#171717] px-3 py-1 rounded-full text-sm transition duration-300 border"
                                style={`color: ${borderColor}; border-color: ${borderColor};`}
                                data-slug={tag.slug}
                                data-hover-bg={borderColor}
                            >
                                #{tag.name}
                            </button>
                        );
                    })}
                </div>
            </header>

            <!-- Blog Content -->
            <article class="prose prose-lg prose-blog max-w-none text-gray-300" set:html={blogHtml} />

            <!-- Footer Actions -->
            <div class="mt-10 pt-10 border-t border-gray-700">
                <div class="flex items-center justify-end flex-wrap gap-4">
                    <!-- Social Share -->
                    <div class="flex gap-3">
                        <button id="share-twitter" class="text-[#60A5FA] hover:text-[#4ADE80] transition duration-300">
                            <FaXTwitter className="h-6 w-6" />
                        </button>
                        <button id="share-instagram" class="text-[#C084FC] hover:text-[#4ADE80] transition duration-300">
                            <FaInstagram className="h-6 w-6" />
                        </button>
                        <button id="share-signal" class="text-[#60A5FA] hover:text-[#4ADE80] transition duration-300">
                            <FaSignalMessenger className="h-6 w-6" />
                        </button>
                        <button id="share-whatsapp" class="text-[#4ADE80] hover:text-[#3FC16F] transition duration-300">
                            <FaWhatsapp className="h-6 w-6" />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</App>

<script>
    // Tag click handlers
    document.querySelectorAll('.tag-btn').forEach(btn => {
        const button = btn as HTMLButtonElement;
        const hoverBg = button.dataset.hoverBg;
        
        // Hover effects
        button.addEventListener('mouseenter', () => {
            if (hoverBg) {
                button.style.backgroundColor = hoverBg;
                button.style.color = 'white';
            }
        });
        button.addEventListener('mouseleave', () => {
            button.style.backgroundColor = '#171717';
            button.style.color = hoverBg || '#4ADE80';
        });
        
        // Click handler
        button.addEventListener('click', () => {
            const slug = button.dataset.slug;
            console.log('Tag clicked:', slug);
        });
    });

    // Get blog info from the page
    const blogTitle = document.querySelector('h1')?.textContent || 'Blog Post';
    const authorElement = document.querySelector('header .flex.items-center:nth-child(2) a, header .flex.items-center:nth-child(2) span');
    const blogAuthor = authorElement?.textContent?.replace('Written by ', '') || 'Author';
    const blogUrl = window.location.href;

    const getShareText = (platform: string) => {
        const base = `ðŸ“– ${blogTitle}\nby ${blogAuthor}\n\n`;

        switch (platform) {
            case 'twitter':
                return `${base}Worth your time ðŸ‘‡\n${blogUrl}`;
            case 'whatsapp':
            case 'signal':
                return `Hey! ðŸ‘‹\n\n${base}Thought you might like it ðŸ˜Š\n${blogUrl}`;
            default:
                return `${base}${blogUrl}`;
        }
    };

    // Social share handlers
    document.getElementById('share-twitter')?.addEventListener('click', () => {
        const text = getShareText('twitter');
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(twitterUrl, '_blank');
    });

    document.getElementById('share-instagram')?.addEventListener('click', () => {
        // Instagram doesn't support direct link sharing, copy to clipboard instead
        const text = getShareText('instagram');
        navigator.clipboard.writeText(text).then(() => {
            alert('Caption copied to clipboard! Open Instagram to share.');
        }).catch(() => {
            alert('Failed to copy. Please share manually.');
        });
    });

    document.getElementById('share-signal')?.addEventListener('click', () => {
        // Signal doesn't have a direct web share URL, try Web Share API or copy
        const text = getShareText('signal');
        if (navigator.share) {
            navigator.share({
                title: blogTitle,
                text: text,
                url: blogUrl
            }).catch(() => {
                // Fallback to clipboard
                navigator.clipboard.writeText(text);
                alert('Copied to clipboard! Open Signal to share.');
            });
        } else {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard! Open Signal to share.');
            });
        }
    });

    document.getElementById('share-whatsapp')?.addEventListener('click', () => {
        const text = getShareText('whatsapp');
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(whatsappUrl, '_blank');
    });
</script>